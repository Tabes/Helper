################################################################################
### Update System Configuration - Central Update Settings
### Configuration File for the Standalone Update System
### Provides Repository URLs, Download Settings, Backup Configuration
################################################################################
### Project: Universal Helper Library
### Version: 1.0.3
### Author:  Mawage (Development Team)
### Date:    2025-09-14
### License: MIT
### Usage:   Source this File to load Update Configuration
### Commit:  Central Update Configuration for Standalone Update System
################################################################################


################################################################################
### === REPOSITORY CONFIGURATION === ###
################################################################################

### Update Repository URLs ###
UPDATE_BASE_URL="${REPO_RAW_URL:-$PROJECT_DOWNLOAD}"
UPDATE_BRANCH="${REPO_BRANCH:-main}"
UPDATE_DEVELOP_BRANCH="${REPO_DEVELOP_BRANCH:-develop}"

### Repository Files ###
UPDATE_MANIFEST="update-manifest.txt"
CHECKSUM_FILE="checksums.sha256"
VERSION_FILE="version.txt"

### Alternative Repository URLs ###
UPDATE_MIRROR_URLS=(
    "https://raw.githubusercontent.com/Tabes/Helper/refs/heads/main"
    "https://cdn.jsdelivr.net/gh/Tabes/Helper@main"
)


################################################################################
### === DOWNLOAD CONFIGURATION === ###
################################################################################

### Download Settings ###
MAX_DOWNLOAD_RETRIES=3
DOWNLOAD_TIMEOUT=30
DOWNLOAD_CHUNK_SIZE="1024"
CONCURRENT_DOWNLOADS=3

### Download Tools Preference ###
PREFERRED_DOWNLOAD_TOOL="curl"  ### curl, wget, auto ###
DOWNLOAD_TOOLS_FALLBACK="true"

### Network Settings ###
CONNECTION_TEST_URL="https://github.com"
CONNECTION_TIMEOUT=10
MAX_DOWNLOAD_SIZE="100M"

### User Agent ###
DOWNLOAD_USER_AGENT="Helper-Update-System/${version:-1.0.0}"


################################################################################
### === BACKUP CONFIGURATION === ###
################################################################################

### Backup Directories ###
UPDATE_BACKUP_DIR="${BACKUP_DIR}/update-$(date +%Y%m%d-%H%M%S)"
UPDATE_TMP_DIR="${CACHE_DIR}/update-tmp"

### Backup Settings ###
BACKUP_RETENTION_DAYS=30
BACKUP_COMPRESSION="true"
BACKUP_COMPRESSION_TOOL="gzip"  ### gzip, bzip2, xz ###
MAX_BACKUP_COUNT=10

### Backup File Patterns ###
BACKUP_INCLUDE_PATTERNS=(
    "*.conf"
    "*.sh" 
    "*.md"
    "*.txt"
)

BACKUP_EXCLUDE_PATTERNS=(
    "*.log"
    "*.tmp"
    "*.bak"
    "*~"
)


################################################################################
### === UPDATE BEHAVIOR === ###
################################################################################

### Update Modes ###
UPDATE_MODE="interactive"  ### interactive, auto, check-only ###
FORCE_UPDATE_DEFAULT="false"
DOWNLOAD_ONLY_DEFAULT="false"

### Update Policies ###
REQUIRE_CONFIRMATION="true"
ALLOW_DOWNGRADE="false"
SKIP_SAME_VERSION="true"
CHECK_DEPENDENCIES="true"

### Update Scheduling ###
AUTO_UPDATE_ENABLED="false"
AUTO_UPDATE_INTERVAL="86400"  ### seconds (24 hours) ###
AUTO_UPDATE_TIME="02:00"      ### HH:MM format ###


################################################################################
### === VALIDATION SETTINGS === ###
################################################################################

### Checksum Validation ###
CHECKSUM_ALGORITHM="sha256"
CHECKSUM_REQUIRED="false"
CHECKSUM_STRICT_MODE="false"

### File Validation ###
VALIDATE_FILE_PERMISSIONS="true"
VALIDATE_FILE_SIZE="true"
MIN_FILE_SIZE="10"      ### bytes ###
MAX_FILE_SIZE="10M"     ### human readable ###

### Signature Validation ###
GPG_SIGNATURE_CHECK="false"
GPG_KEY_ID=""
GPG_KEYRING_PATH=""


################################################################################
### === LOGGING CONFIGURATION === ###
################################################################################

### Update Logging ###
UPDATE_LOG_FILE="${LOG_DIR}/update.log"
UPDATE_LOG_LEVEL="INFO"
UPDATE_LOG_ROTATION="true"
UPDATE_LOG_MAX_SIZE="10M"
UPDATE_LOG_MAX_FILES=5

### Log Detail Levels ###
LOG_DOWNLOAD_PROGRESS="true"
LOG_BACKUP_DETAILS="true"
LOG_VALIDATION_STEPS="true"
LOG_ROLLBACK_ACTIONS="true"

### Debug Logging ###
UPDATE_DEBUG_MODE="false"
DEBUG_PRESERVE_TEMP_FILES="false"
DEBUG_VERBOSE_CURL="false"


################################################################################
### === NOTIFICATION SETTINGS === ###
################################################################################

### Update Notifications ###
NOTIFY_UPDATE_AVAILABLE="true"
NOTIFY_UPDATE_SUCCESS="true"
NOTIFY_UPDATE_FAILURE="true"
NOTIFY_ROLLBACK_COMPLETE="true"

### Notification Methods ###
NOTIFICATION_EMAIL="false"
NOTIFICATION_LOG="true"
NOTIFICATION_CONSOLE="true"

### Email Settings (if enabled) ###
SMTP_SERVER=""
SMTP_PORT="587"
SMTP_USER=""
SMTP_FROM="helper-update@${HOSTNAME:-localhost}"
SMTP_TO="${PROJECT_EMAIL:-admin@localhost}"


################################################################################
### === SECURITY SETTINGS === ###
################################################################################

### Security Policies ###
ALLOW_INSECURE_DOWNLOADS="false"
VERIFY_SSL_CERTIFICATES="true"
REQUIRE_HTTPS="true"

### File Permissions ###
UPDATE_FILE_PERMISSIONS="644"
UPDATE_SCRIPT_PERMISSIONS="755"
UPDATE_CONFIG_PERMISSIONS="600"

### Execution Security ###
SANDBOX_UPDATES="false"
CHROOT_UPDATE_DIR=""
UPDATE_USER=""
UPDATE_GROUP=""


################################################################################
### === ROLLBACK CONFIGURATION === ###
################################################################################

### Rollback Settings ###
AUTO_ROLLBACK_ON_FAILURE="true"
ROLLBACK_TIMEOUT="300"  ### seconds ###
PRESERVE_ROLLBACK_LOGS="true"

### Rollback Validation ###
VALIDATE_ROLLBACK="true"
TEST_ROLLBACK_INTEGRITY="true"
ROLLBACK_CONFIRMATION_REQUIRED="true"

### Emergency Rollback ###
EMERGENCY_ROLLBACK_ENABLED="true"
EMERGENCY_ROLLBACK_FILE="${BACKUP_DIR}/emergency-rollback.tar.gz"


################################################################################
### === PERFORMANCE SETTINGS === ###
################################################################################

### Resource Limits ###
MAX_UPDATE_TIME="1800"     ### seconds (30 minutes) ###
MAX_MEMORY_USAGE="512M"
MAX_DISK_USAGE="1G"

### Parallel Processing ###
PARALLEL_DOWNLOADS="true"
MAX_PARALLEL_JOBS=3
DOWNLOAD_QUEUE_SIZE=10

### Caching ###
CACHE_MANIFESTS="true"
CACHE_CHECKSUMS="true"
CACHE_DURATION="3600"  ### seconds (1 hour) ###


################################################################################
### === MAINTENANCE CONFIGURATION === ###
################################################################################

### Cleanup Settings ###
AUTO_CLEANUP_TEMP="true"
AUTO_CLEANUP_OLD_BACKUPS="true"
CLEANUP_ON_SUCCESS="true"
CLEANUP_ON_FAILURE="false"

### Maintenance Schedule ###
MAINTENANCE_ENABLED="true"
MAINTENANCE_INTERVAL="weekly"  ### daily, weekly, monthly ###
MAINTENANCE_TIME="03:00"

### Statistics ###
COLLECT_UPDATE_STATS="true"
STATS_FILE="${LOG_DIR}/update-stats.json"
STATS_RETENTION_DAYS=90


################################################################################
### === COMPATIBILITY SETTINGS === ###
################################################################################

### Version Compatibility ###
MIN_BASH_VERSION="4.0"
REQUIRED_COMMANDS=(
    "curl:curl"
    "wget:wget" 
    "sha256sum:coreutils"
    "tar:tar"
    "gzip:gzip"
)

### Platform Detection ###
DETECT_PLATFORM="true"
PLATFORM_SPECIFIC_UPDATES="false"

### Legacy Support ###
SUPPORT_LEGACY_MANIFEST="true"
LEGACY_MANIFEST_FORMAT="v1"


################################################################################
### === ADVANCED FEATURES === ###
################################################################################

### Delta Updates ###
ENABLE_DELTA_UPDATES="false"
DELTA_ALGORITHM="bsdiff"
DELTA_COMPRESSION="true"

### Staged Updates ###
ENABLE_STAGED_UPDATES="false"
STAGING_DIRECTORY="${CACHE_DIR}/staging"
STAGING_VALIDATION="true"

### Update Channels ###
DEFAULT_UPDATE_CHANNEL="stable"  ### stable, beta, develop ###
ALLOW_CHANNEL_SWITCHING="false"

CHANNEL_URLS=(
    "stable:${UPDATE_BASE_URL}"
    "beta:${UPDATE_BASE_URL/main/beta}"
    "develop:${UPDATE_BASE_URL/main/develop}"
)


################################################################################
### === ERROR HANDLING === ###
################################################################################

### Error Recovery ###
AUTO_RETRY_FAILED_DOWNLOADS="true"
RETRY_DELAY_MULTIPLIER="2"
MAX_TOTAL_RETRIES="10"

### Error Reporting ###
REPORT_ERRORS="true"
ERROR_REPORT_URL=""
INCLUDE_SYSTEM_INFO="false"

### Fallback Strategies ###
FALLBACK_TO_MIRRORS="true"
FALLBACK_TO_CACHE="true"
FALLBACK_TO_MANUAL="false"


################################################################################
### === INITIALIZATION === ###
################################################################################

### Load additional update configurations if available ###
if [ -f "${PROJECT_ROOT}/configs/update-local.conf" ]; then
    # shellcheck source=/dev/null
    source "${PROJECT_ROOT}/configs/update-local.conf"
fi

### Export configuration status ###
export UPDATE_CONFIG_LOADED="true"
export UPDATE_CONFIG_VERSION="1.0.0"

### Validate configuration ###
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    echo "Update Configuration loaded successfully"
    echo "Repository: $UPDATE_BASE_URL"
    echo "Backup retention: $BACKUP_RETENTION_DAYS days"
    echo "Download timeout: $DOWNLOAD_TIMEOUT seconds"
fi
